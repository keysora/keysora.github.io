<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FoX GeM</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #000;
      color: white;
      overflow: hidden;
      touch-action: manipulation;
    }

    canvas#game {
      display: block;
      margin: 20px auto;
      background: #000;
      z-index: 2;
      position: relative;
    }

    #game-over-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: crimson;
      font-size: 3em;
      font-weight: bold;
      z-index: 5;
      display: none;
      text-align: center;
    }

    .menu {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
      position: relative;
      z-index: 3;
    }

    .button {
      padding: 10px 20px;
      background-color: crimson;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1em;
      z-index: 10;
    }

    .sound-control {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 100;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid crimson;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 20px;
      border: 2px solid crimson;
      border-radius: 15px;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
      width: 80%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .close-btn {
      align-self: flex-end;
      cursor: pointer;
      color: crimson;
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    .leaderboard-entry:nth-child(1) { color: gold; font-weight: bold; }
    .leaderboard-entry:nth-child(2) { color: silver; font-weight: bold; }
    .leaderboard-entry:nth-child(3) { color: #cd7f32; font-weight: bold; }
    .current-user { color: crimson !important; }

    /* –ó–æ–Ω—ã –¥–ª—è —Ç–∞–ø–æ–≤ */
    .control-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 4;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      pointer-events: none;
    }

    .control-zone {
      pointer-events: auto;
      opacity: 0;
    }

    @media (max-width: 768px) {
      canvas#game {
        width: 100%;
        height: auto;
        max-width: 100vw;
        max-height: 70vh;
      }
    }
  </style>
</head>
<body>
  <div class="sound-control" id="soundControl">üîä</div>
  <h1 style="text-align: center; z-index:3; position:relative; color: crimson;">FoX GeM</h1>
  <div id="game-over-text">GAME OVER<br><span style="font-size: 0.6em;">Score: <span id="final-score">0</span></span></div>
  <canvas id="game" width="400" height="400"></canvas>

  <!-- –ó–æ–Ω—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–ø–∞–º–∏ -->
  <div class="control-overlay">
    <div class="control-zone" data-direction="up"></div>
    <div class="control-zone" data-direction="up"></div>
    <div class="control-zone" data-direction="up"></div>
    <div class="control-zone" data-direction="left"></div>
    <div class="control-zone"></div>
    <div class="control-zone" data-direction="right"></div>
    <div class="control-zone" data-direction="down"></div>
    <div class="control-zone" data-direction="down"></div>
    <div class="control-zone" data-direction="down"></div>
  </div>

  <div class="menu">
    <button class="button" onclick="startGame()">Play</button>
    <button class="button" onclick="showAccountPopup()">Account</button>
    <button class="button" onclick="showLeaderboardPopup()">Leaderboard</button>
  </div>

  <!-- [–û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ø–∞–ø—ã –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å] -->

  <script>
    // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const box = 20;
    let snake = [];
    let direction = 'right';
    let food;
    let gameLoop;
    let score = 0;
    const gameOverText = document.getElementById('game-over-text');
    const finalScoreElement = document.getElementById('final-score');

    // –ó–≤—É–∫–∏
    const soundEffects = {
      eat: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3'),
      gameOver: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-lose-2027.mp3'),
      move: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-quick-jump-arcade-game-239.mp3')
    };

    let soundEnabled = true;
    document.getElementById('soundControl').addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      document.getElementById('soundControl').textContent = soundEnabled ? 'üîä' : 'üîá';
    });

    function playSound(sound) {
      if (soundEnabled && soundEffects[sound]) {
        soundEffects[sound].currentTime = 0;
        soundEffects[sound].play().catch(e => console.log('Sound error:', e));
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
    function initGame() {
      snake = [{x: 9 * box, y: 10 * box}];
      direction = 'right';
      generateFood();
      score = 0;
      
      if (gameLoop) clearInterval(gameLoop);
      gameLoop = setInterval(draw, 150);
    }

    function generateFood() {
      food = {
        x: Math.floor(Math.random() * 20) * box,
        y: Math.floor(Math.random() * 20) * box,
      };
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ–±—ã –µ–¥–∞ –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–∞ –∑–º–µ–π–∫–µ
      for (let i = 0; i < snake.length; i++) {
        if (food.x === snake[i].x && food.y === snake[i].y) {
          generateFood();
          break;
        }
      }
    }

    function draw() {
      // –§–æ–Ω —Å —Å–µ—Ç–∫–æ–π
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É (–º–∞—Ç—Ä–∏—Ü—É)
      ctx.strokeStyle = 'rgba(50, 200, 50, 0.3)';
      ctx.lineWidth = 0.5;
      for (let i = 0; i < canvas.width; i += box) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, canvas.height);
        ctx.stroke();
      }
      for (let j = 0; j < canvas.height; j += box) {
        ctx.beginPath();
        ctx.moveTo(0, j);
        ctx.lineTo(canvas.width, j);
        ctx.stroke();
      }

      // –ó–º–µ–π–∫–∞
      for (let i = 0; i < snake.length; i++) {
        ctx.fillStyle = i === 0 ? 'crimson' : 'darkred';
        ctx.fillRect(snake[i].x, snake[i].y, box, box);
        
        // –ì–ª–∞–∑–∞
        if (i === 0) {
          ctx.fillStyle = 'white';
          const eyeSize = box / 5;
          const eyeOffset = box / 4;
          
          if (direction === 'right') {
            ctx.fillRect(snake[i].x + box - eyeOffset, snake[i].y + eyeOffset, eyeSize, eyeSize);
            ctx.fillRect(snake[i].x + box - eyeOffset, snake[i].y + box - eyeOffset * 2, eyeSize, eyeSize);
          } else if (direction === 'left') {
            ctx.fillRect(snake[i].x + eyeOffset - eyeSize, snake[i].y + eyeOffset, eyeSize, eyeSize);
            ctx.fillRect(snake[i].x + eyeOffset - eyeSize, snake[i].y + box - eyeOffset * 2, eyeSize, eyeSize);
          } else if (direction === 'up') {
            ctx.fillRect(snake[i].x + eyeOffset, snake[i].y + eyeOffset - eyeSize, eyeSize, eyeSize);
            ctx.fillRect(snake[i].x + box - eyeOffset * 2, snake[i].y + eyeOffset - eyeSize, eyeSize, eyeSize);
          } else if (direction === 'down') {
            ctx.fillRect(snake[i].x + eyeOffset, snake[i].y + box - eyeOffset, eyeSize, eyeSize);
            ctx.fillRect(snake[i].x + box - eyeOffset * 2, snake[i].y + box - eyeOffset, eyeSize, eyeSize);
          }
        }
      }

      // –ï–¥–∞ (–±–µ–ª–∞—è)
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(food.x + box/2, food.y + box/2, box/2 - 2, 0, Math.PI * 2);
      ctx.fill();

      // –î–≤–∏–∂–µ–Ω–∏–µ
      let headX = snake[0].x;
      let headY = snake[0].y;

      if (direction === 'left') headX -= box;
      if (direction === 'right') headX += box;
      if (direction === 'up') headY -= box;
      if (direction === 'down') headY += box;

      // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
      if (
        headX < 0 || headX >= canvas.width ||
        headY < 0 || headY >= canvas.height ||
        collision({x: headX, y: headY}, snake)
      ) {
        gameOver();
        return;
      }

      // –°—ä–µ–ª–∞ –µ–¥—É
      if (headX === food.x && headY === food.y) {
        playSound('eat');
        score += 3; // +3 –æ—á–∫–∞
        generateFood();
      } else {
        snake.pop();
      }

      snake.unshift({x: headX, y: headY});
    }

    function collision(head, array) {
      for (let i = 0; i < array.length; i++) {
        if (head.x === array[i].x && head.y === array[i].y) {
          return true;
        }
      }
      return false;
    }

    function gameOver() {
      clearInterval(gameLoop);
      playSound('gameOver');
      finalScoreElement.textContent = score;
      gameOverText.style.display = 'block';
      saveScore();
    }

    function startGame() {
      gameOverText.style.display = 'none';
      initGame();
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–ø–∞–º–∏
    document.querySelectorAll('.control-zone').forEach(zone => {
      zone.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const newDirection = zone.getAttribute('data-direction');
        if (newDirection && direction !== oppositeDirection(newDirection)) {
          playSound('move');
          direction = newDirection;
        }
      });
    });

    function oppositeDirection(dir) {
      switch (dir) {
        case 'left': return 'right';
        case 'right': return 'left';
        case 'up': return 'down';
        case 'down': return 'up';
        default: return '';
      }
    }

    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    document.addEventListener('keydown', e => {
      if (['ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown', 'a', 'w', 'd', 's'].includes(e.key)) {
        e.preventDefault();
      }

      if ((e.key === 'ArrowLeft' || e.key === 'a') && direction !== 'right') {
        playSound('move');
        direction = 'left';
      } else if ((e.key === 'ArrowUp' || e.key === 'w') && direction !== 'down') {
        playSound('move');
        direction = 'up';
      } else if ((e.key === 'ArrowRight' || e.key === 'd') && direction !== 'left') {
        playSound('move');
        direction = 'right';
      } else if ((e.key === 'ArrowDown' || e.key === 's') && direction !== 'up') {
        playSound('move');
        direction = 'down';
      }
    });

    // [–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (Telegram, –ø–æ–ø–∞–ø—ã) –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å]

    // –ó–∞–ø—É—Å–∫
    document.addEventListener('DOMContentLoaded', () => {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.expand();
        updateUserInfo();
      }
    });
  </script>
</body>
</html>
